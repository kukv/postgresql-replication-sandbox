x-postgres-common: &postgres-common
  image: postgres:latest
  environment:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    TZ: "Asia/Tokyo"
  command: [ "-c", "hba_file=/etc/postgresql/pg_hba.conf", "-c", "config_file=/etc/postgresql/postgresql.conf" ]
  healthcheck:
    test: pg_isready -h localhost -d postgres -U postgres
    interval: 20s
    timeout: 5s
    retries: 3
  restart: always

services:
  db_primary:
    <<: *postgres-common
    hostname: db_primary
    container_name: db_primary
    ports:
      - 15432:5432
    volumes:
      - ./db_primary/sql:/docker-entrypoint-initdb.d
      - ./db_primary/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ./db_primary/conf/postgresql.conf:/etc/postgresql/postgresql.conf

  db_replica1:
    <<: *postgres-common
    hostname: db_replica1
    container_name: db_replica1
    ports:
      - 25432:5432
    volumes:
      - ./db_replica1/sql:/docker-entrypoint-initdb.d
      - ./db_replica1/scripts/entrypoint.sh:/entrypoint.sh
      - ./db_replica1/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ./db_replica1/conf/postgresql.conf:/etc/postgresql/postgresql.conf
    entrypoint: ["/entrypoint.sh"]
    depends_on:
      db_primary:
        condition: service_healthy

  db_replica2:
    <<: *postgres-common
    hostname: db_replica2
    container_name: db_replica2
    ports:
      - 35432:5432
    volumes:
      - ./db_replica2/sql:/docker-entrypoint-initdb.d
      - ./db_replica2/scripts/entrypoint.sh:/entrypoint.sh
      - ./db_replica2/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ./db_replica2/conf/postgresql.conf:/etc/postgresql/postgresql.conf
    entrypoint: ["/entrypoint.sh"]
    depends_on:
      db_primary:
        condition: service_healthy
